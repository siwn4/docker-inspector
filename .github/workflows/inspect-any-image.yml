name: Universal Image Inspector

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'é•œåƒåï¼ˆå¦‚ï¼šlmentory/wee, nginx, ghcr.io/xxxï¼‰'
        required: true
        default: 'lmentory/wee'
        type: string
      extract_path:
        description: 'è¦æå–çš„è·¯å¾„ï¼ˆé»˜è®¤ /appï¼‰'
        required: false
        default: '/app'
        type: string

jobs:
  inspect:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”„ å¤„ç†é•œåƒå
        id: process_image
        run: |
          IMAGE="${{ github.event.inputs.image }}"
          
          # å¤„ç†é•œåƒå
          if [[ "$IMAGE" == ghcr.io/* ]]; then
            FULL_IMAGE="$IMAGE"
          elif [[ "$IMAGE" == */* ]] && [[ "$IMAGE" != *.* ]]; then
            if [[ "$IMAGE" != *:* ]]; then
              IMAGE="$IMAGE:latest"
            fi
            FULL_IMAGE="docker.io/$IMAGE"
          elif [[ "$IMAGE" == *.* ]] && [[ "$IMAGE" == */* ]]; then
            FULL_IMAGE="$IMAGE"
          else
            if [[ "$IMAGE" != *:* ]]; then
              IMAGE="$IMAGE:latest"
            fi
            FULL_IMAGE="docker.io/library/$IMAGE"
          fi
          
          if [[ "$FULL_IMAGE" != *:* ]]; then
            FULL_IMAGE="$FULL_IMAGE:latest"
          fi
          
          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "display_image=$IMAGE" >> $GITHUB_OUTPUT
          
          echo "## ðŸŽ¯ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¾“å…¥:** \`${{ github.event.inputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**å®Œæ•´è·¯å¾„:** \`$FULL_IMAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¥ æ‹‰å–é•œåƒ
        run: |
          echo "æ­£åœ¨æ‹‰å–: ${{ steps.process_image.outputs.full_image }}"
          docker pull ${{ steps.process_image.outputs.full_image }}
          docker tag ${{ steps.process_image.outputs.full_image }} inspect:latest
      
      - name: ðŸ“Š é•œåƒåŸºæœ¬ä¿¡æ¯
        run: |
          echo "## ðŸ“Š é•œåƒåŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–é•œåƒID
          IMAGE_ID=$(docker images inspect:latest --format='{{.ID}}' | cut -c1-12)
          echo "**é•œåƒ ID:** \`$IMAGE_ID\`" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–å¤§å°ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
          SIZE_BYTES=$(docker image inspect inspect:latest --format='{{.Size}}' 2>/dev/null || echo "0")
          if [ "$SIZE_BYTES" != "0" ]; then
            SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
            echo "**å¤§å°:** ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          else
            echo "**å¤§å°:** æœªçŸ¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          # åˆ›å»ºæ—¶é—´
          CREATED=$(docker inspect inspect:latest --format='{{.Created}}' | cut -c1-19)
          echo "**åˆ›å»ºæ—¶é—´:** $CREATED" >> $GITHUB_STEP_SUMMARY
          
          # æž¶æž„
          ARCH=$(docker inspect inspect:latest --format='{{.Architecture}}')
          OS=$(docker inspect inspect:latest --format='{{.Os}}')
          echo "**å¹³å°:** $OS/$ARCH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸš€ å¯åŠ¨é…ç½®
        run: |
          echo "## ðŸš€ å¯åŠ¨é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ENTRYPOINT=$(docker inspect inspect:latest --format='{{json .Config.Entrypoint}}')
          CMD=$(docker inspect inspect:latest --format='{{json .Config.Cmd}}')
          WORKDIR=$(docker inspect inspect:latest --format='{{.Config.WorkingDir}}')
          USER=$(docker inspect inspect:latest --format='{{.Config.User}}')
          EXPOSE=$(docker inspect inspect:latest --format='{{json .Config.ExposedPorts}}')
          
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Entrypoint** | \`$ENTRYPOINT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cmd** | \`$CMD\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **WorkingDir** | \`${WORKDIR:-/}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **User** | \`${USER:-root}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ExposedPorts** | \`$EXPOSE\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          docker inspect inspect:latest > image-config.json
      
      - name: ðŸŒ çŽ¯å¢ƒå˜é‡
        run: |
          echo "## ðŸŒ çŽ¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm --entrypoint sh inspect:latest -c 'env | sort' 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "æ— æ³•èŽ·å–" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“‚ æ–‡ä»¶ç³»ç»Ÿç»“æž„
        run: |
          echo "## ðŸ“‚ æ–‡ä»¶ç³»ç»Ÿç»“æž„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EXTRACT_PATH="${{ github.event.inputs.extract_path }}"
          
          echo "### æ ¹ç›®å½• (/)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm --entrypoint ls inspect:latest -la / 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "æ— æ³•è¯»å–" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          WORKDIR=$(docker inspect inspect:latest --format='{{.Config.WorkingDir}}')
          if [ -n "$WORKDIR" ] && [ "$WORKDIR" != "/" ]; then
            echo "### å·¥ä½œç›®å½• ($WORKDIR)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            docker run --rm --entrypoint ls inspect:latest -la $WORKDIR 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$EXTRACT_PATH" ] && [ "$EXTRACT_PATH" != "/" ] && [ "$EXTRACT_PATH" != "$WORKDIR" ]; then
            echo "### æŒ‡å®šç›®å½• ($EXTRACT_PATH)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            docker run --rm --entrypoint ls inspect:latest -la $EXTRACT_PATH 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“œ æŸ¥æ‰¾é‡è¦æ–‡ä»¶
        run: |
          echo "## ðŸ“œ é‡è¦æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Shell è„šæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm --entrypoint sh inspect:latest -c "find / -name '*.sh' -type f 2>/dev/null | grep -v '/proc/' | grep -v '/sys/' | head -20" >> $GITHUB_STEP_SUMMARY || echo "æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“ æŸ¥çœ‹å¯åŠ¨è„šæœ¬
        run: |
          echo "## ðŸ“ å¯åŠ¨è„šæœ¬å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å°è¯•æŸ¥æ‰¾å¯åŠ¨è„šæœ¬
          SCRIPTS="/start.sh /entrypoint.sh /app/start.sh /docker-entrypoint.sh"
          
          for script in $SCRIPTS; do
            echo "### æ£€æŸ¥ $script" >> $GITHUB_STEP_SUMMARY
            if docker run --rm --entrypoint test inspect:latest -f $script 2>/dev/null; then
              echo "âœ… æ–‡ä»¶å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              docker run --rm --entrypoint cat inspect:latest $script 2>/dev/null | head -50 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done
      
      - name: ðŸ“¦ æå–æ–‡ä»¶
        run: |
          echo "æ­£åœ¨æå–æ–‡ä»¶..."
          docker create --name temp inspect:latest
          
          EXTRACT_PATH="${{ github.event.inputs.extract_path }}"
          
          mkdir -p extracted-files
          cd extracted-files
          
          # æå–æŒ‡å®šè·¯å¾„
          if [ -n "$EXTRACT_PATH" ]; then
            echo "æå– $EXTRACT_PATH ..."
            docker cp temp:$EXTRACT_PATH ./files 2>/dev/null || {
              echo "$EXTRACT_PATH ä¸å­˜åœ¨æˆ–æ— æ³•æå–"
              # å°è¯•æå–æ ¹ç›®å½•çš„ä¸€äº›å…³é”®æ–‡ä»¶
              mkdir -p files
              docker cp temp:/etc ./files/etc 2>/dev/null || true
              docker cp temp:/usr ./files/usr 2>/dev/null || true
            }
          fi
          
          # æå–è„šæœ¬
          mkdir -p scripts
          for script in /start.sh /entrypoint.sh /app/start.sh; do
            docker cp temp:$script ./scripts/ 2>/dev/null || true
          done
          
          docker rm temp
          
          # åˆ›å»ºè¯´æ˜Ž
          cat > README.txt << EOF
          é•œåƒ: ${{ steps.process_image.outputs.full_image }}
          æå–æ—¶é—´: $(date)
          æå–è·¯å¾„: $EXTRACT_PATH
          
          ç›®å½•è¯´æ˜Ž:
          - files/: æå–çš„æ–‡ä»¶
          - scripts/: å¯åŠ¨è„šæœ¬
          EOF
          
          cd ..
      
      - name: ðŸ“¤ ä¸Šä¼ æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-files
          path: |
            extracted-files/
            image-config.json
      
      - name: âœ… å®Œæˆ
        run: |
          echo "## âœ… ä¾¦æŸ¥å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ **Artifacts** ä¸­ä¸‹è½½ \`docker-image-files\` èŽ·å–æ‰€æœ‰æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” å¯ä»¥å°è¯•çš„å…¶ä»–é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "- \`nginx\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`redis:7\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`node:20-alpine\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/ç”¨æˆ·å/ä»“åº“å\`" >> $GITHUB_STEP_SUMMARY
