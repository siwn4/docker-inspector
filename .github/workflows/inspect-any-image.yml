name: Universal Image Inspector

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'é•œåƒåï¼ˆæ”¯æŒ docker.io/xxx, ghcr.io/xxx, æˆ–ç®€å†™ nginxï¼‰'
        required: true
        default: 'lmentory/wee'
        type: string
      extract_path:
        description: 'è¦æå–çš„è·¯å¾„ï¼ˆé»˜è®¤ /appï¼Œå¯æ”¹ä¸º / æˆ–å…¶ä»–ï¼‰'
        required: false
        default: '/app'
        type: string

jobs:
  inspect:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”„ å¤„ç†é•œåƒå
        id: process_image
        run: |
          IMAGE="${{ github.event.inputs.image }}"
          
          # è‡ªåŠ¨å¤„ç†é•œåƒå
          if [[ "$IMAGE" == ghcr.io/* ]]; then
            # GitHub Container Registry
            echo "æ£€æµ‹åˆ° GitHub é•œåƒ"
            FULL_IMAGE="$IMAGE"
          elif [[ "$IMAGE" == */* ]] && [[ "$IMAGE" != *.* ]]; then
            # Docker Hub æ ¼å¼ (user/repo)
            echo "æ£€æµ‹åˆ° Docker Hub é•œåƒ"
            # å¦‚æžœæ²¡æœ‰æ ‡ç­¾ï¼Œæ·»åŠ  :latest
            if [[ "$IMAGE" != *:* ]]; then
              IMAGE="$IMAGE:latest"
            fi
            FULL_IMAGE="docker.io/$IMAGE"
          elif [[ "$IMAGE" == *.* ]] && [[ "$IMAGE" == */* ]]; then
            # å®Œæ•´åŸŸåæ ¼å¼ï¼ˆå¦‚ quay.io/xxxï¼‰
            echo "æ£€æµ‹åˆ°å®Œæ•´åŸŸåæ ¼å¼"
            FULL_IMAGE="$IMAGE"
          else
            # ç®€å•é•œåƒåï¼ˆå¦‚ nginx, alpineï¼‰
            echo "æ£€æµ‹åˆ°å®˜æ–¹é•œåƒ"
            if [[ "$IMAGE" != *:* ]]; then
              IMAGE="$IMAGE:latest"
            fi
            FULL_IMAGE="docker.io/library/$IMAGE"
          fi
          
          # ç¡®ä¿æœ‰æ ‡ç­¾
          if [[ "$FULL_IMAGE" != *:* ]]; then
            FULL_IMAGE="$FULL_IMAGE:latest"
          fi
          
          echo "åŽŸå§‹è¾“å…¥: ${{ github.event.inputs.image }}"
          echo "å¤„ç†åŽ: $FULL_IMAGE"
          
          # è¾“å‡ºå˜é‡
          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "display_image=$IMAGE" >> $GITHUB_OUTPUT
          
          # æ·»åŠ åˆ° Summary
          echo "## ðŸŽ¯ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¾“å…¥:** \`${{ github.event.inputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**å®Œæ•´è·¯å¾„:** \`$FULL_IMAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¥ æ‹‰å–é•œåƒ
        run: |
          echo "æ­£åœ¨æ‹‰å–: ${{ steps.process_image.outputs.full_image }}"
          docker pull ${{ steps.process_image.outputs.full_image }}
          
          # åˆ›å»ºç®€çŸ­åˆ«å
          docker tag ${{ steps.process_image.outputs.full_image }} inspect:latest
      
      - name: ðŸ“Š é•œåƒåŸºæœ¬ä¿¡æ¯
        run: |
          echo "## ðŸ“Š é•œåƒåŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # é•œåƒå¤§å°
          SIZE=$(docker images inspect:latest --format='{{.Size}}' | numfmt --to=iec-i --suffix=B)
          echo "**å¤§å°:** $SIZE" >> $GITHUB_STEP_SUMMARY
          
          # åˆ›å»ºæ—¶é—´
          CREATED=$(docker inspect inspect:latest --format='{{.Created}}')
          echo "**åˆ›å»ºæ—¶é—´:** $CREATED" >> $GITHUB_STEP_SUMMARY
          
          # æž¶æž„
          ARCH=$(docker inspect inspect:latest --format='{{.Architecture}}')
          OS=$(docker inspect inspect:latest --format='{{.Os}}')
          echo "**å¹³å°:** $OS/$ARCH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸš€ å¯åŠ¨é…ç½®
        run: |
          echo "## ðŸš€ å¯åŠ¨é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # èŽ·å–é…ç½®
          ENTRYPOINT=$(docker inspect inspect:latest --format='{{json .Config.Entrypoint}}')
          CMD=$(docker inspect inspect:latest --format='{{json .Config.Cmd}}')
          WORKDIR=$(docker inspect inspect:latest --format='{{.Config.WorkingDir}}')
          USER=$(docker inspect inspect:latest --format='{{.Config.User}}')
          EXPOSE=$(docker inspect inspect:latest --format='{{json .Config.ExposedPorts}}')
          
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **Entrypoint** | \`$ENTRYPOINT\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cmd** | \`$CMD\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **WorkingDir** | \`${WORKDIR:-/}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **User** | \`${USER:-root}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ExposedPorts** | \`$EXPOSE\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ä¿å­˜å®Œæ•´é…ç½®
          docker inspect inspect:latest > image-config.json
      
      - name: ðŸŒ çŽ¯å¢ƒå˜é‡
        run: |
          echo "## ðŸŒ çŽ¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm inspect:latest env 2>/dev/null | sort >> $GITHUB_STEP_SUMMARY || echo "æ— æ³•èŽ·å–" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“‚ æ–‡ä»¶ç³»ç»Ÿç»“æž„
        run: |
          echo "## ðŸ“‚ æ–‡ä»¶ç³»ç»Ÿç»“æž„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EXTRACT_PATH="${{ github.event.inputs.extract_path }}"
          
          # æ ¹ç›®å½•
          echo "### æ ¹ç›®å½• (/)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm inspect:latest ls -la / 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å·¥ä½œç›®å½•
          WORKDIR=$(docker inspect inspect:latest --format='{{.Config.WorkingDir}}')
          if [ -n "$WORKDIR" ] && [ "$WORKDIR" != "/" ]; then
            echo "### å·¥ä½œç›®å½• ($WORKDIR)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            docker run --rm inspect:latest ls -la $WORKDIR 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "ç›®å½•ä¸å­˜åœ¨æˆ–æ— æƒé™" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ç”¨æˆ·æŒ‡å®šç›®å½•
          if [ -n "$EXTRACT_PATH" ] && [ "$EXTRACT_PATH" != "/" ] && [ "$EXTRACT_PATH" != "$WORKDIR" ]; then
            echo "### æŒ‡å®šç›®å½• ($EXTRACT_PATH)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            docker run --rm inspect:latest ls -la $EXTRACT_PATH 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "ç›®å½•ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“œ æŸ¥æ‰¾é‡è¦æ–‡ä»¶
        run: |
          echo "## ðŸ“œ é‡è¦æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾è„šæœ¬æ–‡ä»¶
          echo "### Shell è„šæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm inspect:latest find / -name "*.sh" -type f 2>/dev/null | grep -v '/proc/' | grep -v '/sys/' | head -20 >> $GITHUB_STEP_SUMMARY || echo "æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾é…ç½®æ–‡ä»¶
          echo "### é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          docker run --rm inspect:latest find / -name "*.conf" -o -name "*.yaml" -o -name "*.yml" -o -name "*.json" -o -name "*.toml" -type f 2>/dev/null | grep -v '/proc/' | grep -v '/sys/' | head -20 >> $GITHUB_STEP_SUMMARY || echo "æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“ æŸ¥çœ‹å¯åŠ¨è„šæœ¬
        run: |
          echo "## ðŸ“ å¯åŠ¨è„šæœ¬å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¸¸è§å¯åŠ¨è„šæœ¬ä½ç½®
          SCRIPTS=(
            "/start.sh"
            "/entrypoint.sh"
            "/app/start.sh"
            "/app/entrypoint.sh"
            "/docker-entrypoint.sh"
            "/usr/local/bin/docker-entrypoint.sh"
            "/run.sh"
          )
          
          for script in "${SCRIPTS[@]}"; do
            echo "### æ£€æŸ¥ $script" >> $GITHUB_STEP_SUMMARY
            if docker run --rm inspect:latest test -f $script; then
              echo "âœ… æ–‡ä»¶å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              docker run --rm inspect:latest cat $script 2>/dev/null | head -100 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done
      
      - name: ðŸ“¦ æå–æ–‡ä»¶
        run: |
          echo "æ­£åœ¨æå–æ–‡ä»¶..."
          docker create --name temp inspect:latest
          
          EXTRACT_PATH="${{ github.event.inputs.extract_path }}"
          WORKDIR=$(docker inspect inspect:latest --format='{{.Config.WorkingDir}}')
          
          # åˆ›å»ºç›®å½•
          mkdir -p extracted-files
          cd extracted-files
          
          # æå–æŒ‡å®šè·¯å¾„
          if [ -n "$EXTRACT_PATH" ]; then
            echo "æå– $EXTRACT_PATH ..."
            docker cp temp:$EXTRACT_PATH ./custom-path 2>/dev/null || echo "$EXTRACT_PATH ä¸å­˜åœ¨"
          fi
          
          # æå–å·¥ä½œç›®å½•
          if [ -n "$WORKDIR" ] && [ "$WORKDIR" != "/" ] && [ "$WORKDIR" != "$EXTRACT_PATH" ]; then
            echo "æå–å·¥ä½œç›®å½• $WORKDIR ..."
            docker cp temp:$WORKDIR ./workdir 2>/dev/null || true
          fi
          
          # æå–å¸¸è§è„šæœ¬
          mkdir -p scripts
          for script in /start.sh /entrypoint.sh /docker-entrypoint.sh /run.sh; do
            docker cp temp:$script ./scripts/ 2>/dev/null || true
          done
          
          # æå–é…ç½®æ–‡ä»¶
          mkdir -p configs
          docker cp temp:/etc ./configs/etc 2>/dev/null || true
          
          docker rm temp
          
          # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
          cat > README.txt << EOF
          é•œåƒ: ${{ steps.process_image.outputs.full_image }}
          æå–æ—¶é—´: $(date)
          æå–è·¯å¾„: $EXTRACT_PATH
          å·¥ä½œç›®å½•: $WORKDIR
          
          ç›®å½•è¯´æ˜Ž:
          - custom-path/: ç”¨æˆ·æŒ‡å®šçš„ $EXTRACT_PATH ç›®å½•
          - workdir/: é•œåƒçš„å·¥ä½œç›®å½•
          - scripts/: å¯åŠ¨è„šæœ¬
          - configs/: é…ç½®æ–‡ä»¶
          EOF
          
          cd ..
      
      - name: ðŸ“¤ ä¸Šä¼ æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-files
          path: |
            extracted-files/
            image-config.json
      
      - name: âœ… å®Œæˆæ€»ç»“
        run: |
          echo "## âœ… ä¾¦æŸ¥å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ **Artifacts** ä¸­ä¸‹è½½ \`docker-image-files.zip\` èŽ·å–ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- é•œåƒé…ç½®æ–‡ä»¶ (image-config.json)" >> $GITHUB_STEP_SUMMARY
          echo "- æå–çš„æ–‡ä»¶ (extracted-files/)" >> $GITHUB_STEP_SUMMARY
          echo "- å¯åŠ¨è„šæœ¬ (scripts/)" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®æ–‡ä»¶ (configs/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¸¸ç”¨é•œåƒç¤ºä¾‹
          echo "### ðŸ” å…¶ä»–é•œåƒç¤ºä¾‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä½ å¯ä»¥å°è¯•ä¾¦æŸ¥è¿™äº›é•œåƒï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- \`nginx\` - å®˜æ–¹ Nginx" >> $GITHUB_STEP_SUMMARY
          echo "- \`mysql:8.0\` - MySQL æ•°æ®åº“" >> $GITHUB_STEP_SUMMARY
          echo "- \`node:18-alpine\` - Node.js" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/ç”¨æˆ·å/ä»“åº“å\` - GitHub é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "- \`lmentory/wee\` - ä½ çš„ WebDAV" >> $GITHUB_STEP_SUMMARY
